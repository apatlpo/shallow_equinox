
# Install on datarmor via MPT and Intel compiler


## Install mercurial

Install conda, see [CONDA doc](https://github.com/apatlpo/shallow_equinox/blob/master/doc/conda.md)

```
conda activate vacumm # load python 2.7
pip install --user mercurial
```

Add in `~/.cshrc`:

```
#..... pip --user install
set pathifr = ($pathifr $home/.local/bin)
#..... path final
set path = ($pathifr $path)
```

## Compiler environment 

```
module purge
```

Without mkl (recommended):

```
module load intel-cc-18 mpt/2.17  gcc/5.3.0

```

With mkl (no parallel fft possible then):

```
module load intel-cc-18 mpt/2.17 intel-cmkl-18 gcc/5.3.0  # (with intel-numpy)
```

Adjust several environment variables:

```
setenv MPICC_CC icc
setenv MPICXX_CXX icpc
setenv MPI_PATH $MPI_ROOT
setenv CXXFLAGS "-std=c++11"
```


## Conda environment

Create a conda environment:

```
conda create -y -n fluidsim -c conda-forge python=3.6
conda activate fluidsim
```

Install mpi4py with pip such that mpi4py works with MPT (SGI MPI)

```
pip install mpi4py --no-deps --no-cache-dir --no-binary mpi4py
```

Without mkl (recommended, *beware: blas version is fixed to 1.0*):

```
conda install -y numpy matplotlib h5py blas=1.0=openblas
conda install -y scipy pandas ipython cython psutil
```

or with mkl (no parallel fft possible then):

```
pip install intel-numpy --no-cache-dir
pip install matplotlib
pip install h5py
pip install intel-scipy --no-cache-dir
pip install pandas
pip install ipython
pip install cython
pip install psutil
```

Install other libraries:

```
pip install pythran --no-cache-dir
pip install colorlog
pip install mako
```


## Config file for pythran:

Intel C++ compiler can not compile C++ generated by Pythran so we create a file `.pythranrc`:

```
vi ~/.pythranrc
```

And copy/paste:

```
[compiler]
CC=gcc
CXX=g++

[pythran]
complex_hook = True
```

## Install hdf5 parallel

```
mkdir -p $HOME/lib
cd $HOME/lib
```

Go with your browser to [HD5 current source webpage](https://support.hdfgroup.org/ftp/HDF5/current/src/).
Search for the appropriate version number and update lines below 
accordingly:

```
wget https://support.hdfgroup.org/ftp/HDF5/current/src/hdf5-1.10.4.tar.gz
tar -zxf hdf5-1.10.4.tar.gz
cd hdf5-1.10.4
set PREFIX=$HOME/lib/hdf5/1.10.4
mkdir -p $PREFIX
./configure --enable-parallel --prefix=$PREFIX
make -j 4 && make install
# ../libtool: line 1762: warning: setlocale: LC_CTYPE: cannot change locale (UTF-8)
setenv LD_LIBRARY_PATH $HOME/lib/hdf5/1.10.4/lib:$LD_LIBRARY_PATH
setenv C_INCLUDE_PATH $HOME/lib/hdf5/1.10.4/include:$C_INCLUDE_PATH
```


## Install fftw3

```
cd $HOME/lib
wget http://www.fftw.org/fftw-3.3.7.tar.gz
tar xf fftw-3.3.7.tar.gz
cd fftw-3.3.7

set PREFIX=$HOME/lib/fftw/3.3.7
mkdir -p $PREFIX

# double
./configure CC=icc CFLAGS=-gcc --with-our-malloc16 --enable-threads --enable-openmp --enable-mpi --enable-shared --enable-avx --enable-avx2 --prefix=$PREFIX
make clean
make -j 4 && make install

# single
./configure CC=icc CFLAGS=-gcc --with-our-malloc16 --enable-threads --enable-float --enable-openmp --enable-mpi --enable-shared --enable-avx --enable-avx2 --prefix=$PREFIX
make clean
make -j 4 && make install

# long double
./configure CC=icc CFLAGS=-gcc --with-our-malloc16 --enable-threads --enable-long-double --enable-openmp --enable-mpi --enable-shared --prefix=$PREFIX
make clean
make -j 4 && make install
```


## Adjust paths

```
set FLUIDPATH=fluidsim
setenv LD_LIBRARY_PATH $HOME/lib/fftw/3.3.7/lib:$LD_LIBRARY_PATH
setenv LD_LIBRARY_PATH $HOME/.miniconda2/envs/$FLUIDPATH/lib:$LD_LIBRARY_PATH
setenv C_INCLUDE_PATH $HOME/lib/fftw/3.3.7/include:$C_INCLUDE_PATH
setenv C_INCLUDE_PATH $HOME/.miniconda2/envs/$FLUIDPATH/include:$C_INCLUDE_PATH
```

## Installation fluiddyn

**AP: Tester sans cette partie**

With pip:

```
pip install hg+https://bitbucket.org/fluiddyn/fluiddyn --no-cache-dir
```

or

```
hg clone https://bitbucket.org/fluiddyn/fluiddyn
cd fluiddyn
hg up master
make
```

## Install fluidfft

Create a config file:

```
cd
vi .fluidfft-site.cfg
```

and copy/paste:

```
[fftw3]
use = True
dir = ~/lib/fftw/3.3.7
include_dir = ~/lib/fftw/3.3.7/include
library_dir = ~/lib/fftw/3.3.7/lib

[fftw3_mpi]
use = True
dir = ~/lib/fftw/3.3.7
include_dir = ~/lib/fftw/3.3.7/include
library_dir = ~/lib/fftw/3.3.7/lib

[cufft]
use = False
dir =
include_dir =
library_dir =

[pfft]
use = False
dir =
include_dir =
library_dir =

[p3dfft]
use = False
dir =
include_dir =
library_dir =

[environ]
## Uncomment and specify the following libions to modify compilation of
## extensions.

## To modify compiler used to build Cython extensions:
# MPICXX =
# LDSHARED =

## To modify target architecture while building Pythran extensions
## Useful when cross-compiling. See whether it is required by comparing:
## gcc -march=native -Q --help=target
## gcc -march=$CARCH -Q --help=target
# CARCH =
```

Recommended:

```
pip install hg+https://bitbucket.org/fluiddyn/fluidfft --no-cache-dir
```

Alternatively:

```
hg clone https://bitbucket.org/fluiddyn/fluidfft
cd fluidfft
hg up master
make
```

## Install fluidsim

```
set PREFIX=$HOME/lib/fftw/3.3.7
setenv LDFLAGS -L$PREFIX/lib
setenv CPPFLAGS -I$PREFIX/include
setenv CFLAGS -I$PREFIX/include

wget https://bitbucket.org/fluiddyn/fluidsim/raw/default/site.cfg.default -O ~/.fluidsim-site.cfg
```

Modify `~/.fluidsim-site.cfg` :

```
fluidsim.solvers.sw1l = False
```

Recommended:

```
pip install fluidpythran --no-cache-dir
pip install pyFFTW==0.10.4 # temporary, waiting for 0.11.0 install to be fixed
hg clone https://bitbucket.org/fluiddyn/fluidsim
cd fluidsim
hg up master
make
```

or:

```
pip install hg+https://bitbucket.org/fluiddyn/fluidsim --no-cache-dir
```


## Install fluidsim_ocean

Recommended:

```
hg clone https://bitbucket.org/fluiddyn/fluidsim_ocean
cd fluidsim_ocean
make
```

or:

```
pip install hg+https://bitbucket.org/fluiddyn/fluidsim_ocean --no-cache-dir
```
